\section{Hardware Analysis}

\subsection{Block diagram}\todo{change}

The block diagram shown in \autoref{fig:block_diagram_hardware} provides an overview of the complete hardware architecture. It illustrates how the STM32WL55JC microcontroller interacts with the different sensors and output devices integrated into the system. Each peripheral is connected through the appropriate interface, such as analog inputs, \gls{I2C} buses, \gls{UART} communication lines, and \gls{GPIO} pins, allowing the microcontroller to gather environmental data, process it, and generate feedback. 

This diagram serves as a high-level representation of the system's structure, highlighting the flow of information between components and the role of the microcontroller as the central control unit.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\textwidth]{images/block_diagram.png}
    \caption{Block Diagram of the Hardware System}
    \label{fig:block_diagram_hardware}
\end{figure}

The microcontroller employs several of its internal peripherals to interface with the different sensors and modules in the system. One of the available \gls{ADC} channels is used to read the analog outputs of the soil moisture sensor and the ambient light phototransistor. The \gls{I2C}2 bus is shared by the temperature and humidity sensor (Si7021), the colour sensor (TCS34725), and the accelerometer (MMA8451Q). A \gls{UART} interface is dedicated to the \gls{GPS} module, enabling continuous reception of positioning data.

In addition, three \gls{GPIO} pins are configured as digital outputs to drive the RGB LED through current-limiting resistors. The system also uses the 3.3V and 5V power rails provided by the board, as well as the ground reference shared by all components. Together, these resources form a compact and energy-efficient hardware configuration that leverages the STM32WL55JC's \glspl{ADC}, \glspl{GPIO}, communication peripherals, and power distribution capabilities.

\subsection{Interfaces of the system}

\autoref{tab:system_connections} details all electrical interfaces used in the system. Each sensor or module is mapped to the corresponding ESP32 DevKit V1 pins, specifying power connections, communication buses, and signal types. The design integrates a mix of digital and analog interfaces, including \gls{SPI} for the \gls{RFID} reader, a 2-wire serial interface for the \gls{HX711} load cell amplifier, and a single-bus protocol for the \gls{DHT22} sensor. Additionally, \gls{PWM} signals are used for servo motor control, and \gls{GPIO} pins drive the status \gls{RGB} \gls{LED} to indicate door states.

\begin{table}[H]
    \centering
    \caption{System Connections (ESP32)}
    \label{tab:system_connections}
    \footnotesize
    \begin{tabular}{p{0.18\textwidth}p{0.18\textwidth}p{0.15\textwidth}p{0.12\textwidth}p{0.25\textwidth}}
        \toprule
        \textbf{Module} & \textbf{Component} & \textbf{Pin Name} & \textbf{ESP32 Pin} & \textbf{Function/Protocol} \\
        \midrule

        % RGB LED
        \multirow{3}{*}{\gls{LED} \gls{RGB}} & \multirow{3}{*}{\makecell[l]{Common Anode\\+ Resistors}} 
        & Red   & GPIO 25 & Status (Closed) \\
        & & Green & GPIO 26 & Status (Open) \\
        & & Blue  & GPIO 27 & Status Indicator \\
        \midrule

        % DHT22
        Temp / Hum & DHT22 & Data & GPIO 15 & Single-Bus Digital \\
        \midrule

        % HX711
        \multirow{2}{*}{Weight Scale} & \multirow{2}{*}{HX711 Amp} 
        & DOUT & GPIO 16 & Serial Data Out \\
        & & SCK  & GPIO 4  & Serial Clock \\
        \midrule

        % MFRC522 (RFID)
        \multirow{4}{*}{Access Control} & \multirow{4}{*}{MFRC522 (RFID)} 
        & SCK  & GPIO 18 & \gls{SPI} Clock \\
        & & MISO & GPIO 19 & \gls{SPI} Master In \\
        & & MOSI & GPIO 23 & \gls{SPI} Master Out \\
        & & SS   & GPIO 5  & \gls{SPI} Slave Select \\
        \midrule

        % Servos
        \multirow{2}{*}{Actuators} & \multirow{2}{*}{Servo Motors} 
        & Servo 1 & GPIO 2  & \gls{PWM} Control \\
        & & Servo 2 & GPIO 13 & \gls{PWM} Control \\
        
        \bottomrule
    \end{tabular}
\end{table}

\clearpage

\subsection{Hardware devices}

\subsubsection{ESP32 microcontroller} \todo{change}

The STM32WL55JC\cite{STM32WL55JCProductSTMicroelectronics} is an ultra-low-power microcontroller that integrates both a processing unit and a long-range sub-GHz radio in a single chip. It combines an \gls{ARM} Cortex-M4 core for the main application and an \gls{ARM} Cortex-M0+ core for security and background tasks, providing efficient performance with very low energy consumption. The device includes 256KB of Flash, 64KB of \gls{SRAM}, and a wide set of protection features to ensure firmware integrity.

Its built-in radio supports several \gls{LPWAN} modulations, including \gls{LoRa}, enabling long-distance communication. The microcontroller also offers a rich collection of peripheralsâ€”such as 12-bit \gls{ADC}/\gls{DAC}, multiple timers, \gls{DMA} controllers, and interfaces like \gls{UART}, \gls{I2C}, and \gls{SPI}, making it highly adaptable to sensor-based and low-power embedded applications.

\subsubsection{RGB LED and 470 Ohm resistors}

The system includes a common-anode \gls{RGB} \gls{LED} used to provide visual feedback during operation. This type of \gls{LED} shares a single positive terminal connected to the 3.3,V rail, while each color channel (red, green, and blue) is controlled individually through the microcontroller. The STM32WL55JC drives the three channels using pins PA\_6, PA\_7, and PA\_9, which can be toggled to generate different brightness levels and color combinations.

Each \gls{LED} channel is connected in series with a 470 Ohm resistor to ensure proper current limiting and protect both the \gls{LED} and the microcontroller outputs. This simple circuit allows the system to display a wide range of colors, enabling intuitive status indication, such as alerts or measurement feedback.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.3\textwidth]{images/rgb_circuit.png}
    \caption{RGB LED circuit diagram}
    \label{fig:rgb_circuit}
\end{figure}

\subsubsection{Si7021 Temperature and Humidity Sensor}\todo{change}

The system integrates a Si7021 digital temperature and humidity sensor\cite{industriesAdafruitSi7021Temperature} to monitor environmental conditions. This sensor communicates with the STM32WL55JC microcontroller via the \gls{I2C}2 bus, using pins PA\_12 (\gls{SCL}) and PA\_11 (\gls{SDA}). The sensor is powered by the 5V supply from the board, while a shared ground ensures reliable communication and stable operation.

The Si7021 provides fully digital readings for both temperature and relative humidity, eliminating the need for additional signal conditioning or \gls{ADC} conversion. 

\gls{RH} is the amount of water vapor present in the air expressed as a percentage of the maximum humidity the air can hold at a given temperature. Mathematically, it is expressed as:

\[
\text{RH (\%)} = \frac{P_\text{humidity}}{P_\text{max\_humidity}(T)} \times 100
\]

The microcontroller can query the sensor at regular intervals to obtain accurate temperature in degrees Celsius and relative humidity in percentage. These measurements can then be used for environmental monitoring, data logging, or as input for control algorithms, such as adjusting irrigation based on humidity levels.
